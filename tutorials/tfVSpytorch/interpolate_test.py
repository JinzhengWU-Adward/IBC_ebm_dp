"""
éªŒè¯ TensorFlow tf.image.resize å’Œ PyTorch F.interpolate çš„å·®å¼‚

ä»æ•°å­¦è§’åº¦ + å®é™…åº“å®ç° + é»˜è®¤å‚æ•° + è¾¹ç•Œè¡Œä¸º + å¯¹é½ç­–ç•¥ 5 ä¸ªå±‚é¢è¿›è¡ŒéªŒè¯
ä½¿ç”¨ IBC_ebm_dp/data/pushing_pixel ä¸‹çš„å®é™…å›¾åƒæ•°æ®
"""

import numpy as np
import torch
import torch.nn.functional as F
from PIL import Image
from pathlib import Path
import matplotlib.pyplot as plt
import sys
import os

# æŠ‘åˆ¶ TensorFlow çš„ INFO å’Œ WARNING æ—¥å¿—
os.environ['TF_CPP_MIN_LOG_LEVEL'] = '2'  # 0=all, 1=info, 2=warnings, 3=errors

# å°è¯•å¯¼å…¥ TensorFlowï¼ˆå¦‚æœå¯ç”¨ï¼‰
try:
    import tensorflow as tf
    TF_AVAILABLE = True
    TF_VERSION = tf.__version__
    print(f"âœ“ TensorFlow å¯ç”¨ (ç‰ˆæœ¬: {TF_VERSION})")
    
    # TensorFlow 2.x çš„ tf.image.resize ä¸æ”¯æŒ align_corners å‚æ•°
    # éœ€è¦ä½¿ç”¨ tf.compat.v1.image.resize_images æ¥æµ‹è¯• align_corners
    # æˆ–è€…ä½¿ç”¨ tf.image.resizeï¼ˆé»˜è®¤ç›¸å½“äº align_corners=Falseï¼‰
    def tf_resize(images, size, method='bilinear', align_corners=False):
        """
        TensorFlow resize çš„å…¼å®¹å‡½æ•°
        åœ¨ TF 2.x ä¸­ï¼Œtf.image.resize é»˜è®¤ç›¸å½“äº align_corners=False
        å¦‚æœè¦æµ‹è¯• align_corners=Trueï¼Œéœ€è¦ä½¿ç”¨ compat.v1 API
        """
        if align_corners:
            # ä½¿ç”¨ compat.v1 API æ”¯æŒ align_corners=True
            return tf.compat.v1.image.resize_images(
                images, size, method=tf.compat.v1.image.ResizeMethod.BILINEAR,
                align_corners=True
            )
        else:
            # TF 2.x çš„é»˜è®¤è¡Œä¸ºï¼ˆhalf-pixel centerï¼Œç›¸å½“äº align_corners=Falseï¼‰
            return tf.image.resize(images, size, method=method)
            
except ImportError:
    TF_AVAILABLE = False
    TF_VERSION = None
    print("âš  TensorFlow ä¸å¯ç”¨ï¼Œå°†è·³è¿‡ TF ç›¸å…³æµ‹è¯•")

# æ·»åŠ é¡¹ç›®è·¯å¾„
IBC_ROOT = Path(__file__).parent.parent
DATA_DIR = IBC_ROOT / "data" / "pushing_pixel"


def load_test_image():
    """ä» pushing_pixel æ•°æ®ç›®å½•åŠ è½½ä¸€å¼ æµ‹è¯•å›¾åƒ"""
    # æŸ¥æ‰¾ç¬¬ä¸€ä¸ªè½¨è¿¹ç›®å½•
    traj_dirs = sorted(DATA_DIR.glob("traj_*"))
    if not traj_dirs:
        raise FileNotFoundError(f"æœªæ‰¾åˆ°è½¨è¿¹æ•°æ®ç›®å½•: {DATA_DIR}")
    
    traj_dir = traj_dirs[0]
    image_path = traj_dir / "frame_0000.png"
    
    if not image_path.exists():
        raise FileNotFoundError(f"æœªæ‰¾åˆ°å›¾åƒæ–‡ä»¶: {image_path}")
    
    # åŠ è½½å›¾åƒ
    img = Image.open(image_path).convert('RGB')
    img_array = np.array(img, dtype=np.float32)  # (H, W, 3), [0, 255]
    
    print(f"âœ“ åŠ è½½æµ‹è¯•å›¾åƒ: {image_path}")
    print(f"  åŸå§‹å°ºå¯¸: {img_array.shape}")
    
    return img_array, image_path


def test_align_corners_effect():
    """æµ‹è¯• align_corners å‚æ•°çš„å½±å“"""
    print("\n" + "="*80)
    print("æµ‹è¯• 1: align_corners å‚æ•°çš„å½±å“")
    print("="*80)
    
    # åˆ›å»ºä¸€ä¸ªç®€å•çš„æµ‹è¯•å›¾åƒï¼ˆ4x4ï¼‰
    test_img = np.arange(16, dtype=np.float32).reshape(4, 4, 1)  # (4, 4, 1)
    test_img = np.repeat(test_img, 3, axis=2)  # (4, 4, 3)
    test_img = test_img / 16.0  # å½’ä¸€åŒ–åˆ° [0, 1]
    
    print(f"è¾“å…¥å›¾åƒå°ºå¯¸: {test_img.shape}")
    print(f"è¾“å…¥å›¾åƒå€¼èŒƒå›´: [{test_img.min():.3f}, {test_img.max():.3f}]")
    
    target_size = (8, 8)  # æ”¾å¤§ 2 å€
    
    # PyTorch: align_corners=True
    img_torch = torch.FloatTensor(test_img).permute(2, 0, 1).unsqueeze(0)  # (1, 3, 4, 4)
    resized_torch_true = F.interpolate(
        img_torch, size=target_size, mode='bilinear', align_corners=True
    ).squeeze(0).permute(1, 2, 0).numpy()
    
    # PyTorch: align_corners=False
    resized_torch_false = F.interpolate(
        img_torch, size=target_size, mode='bilinear', align_corners=False
    ).squeeze(0).permute(1, 2, 0).numpy()
    
    print(f"\nPyTorch align_corners=True  è¾“å‡ºå°ºå¯¸: {resized_torch_true.shape}")
    print(f"PyTorch align_corners=False è¾“å‡ºå°ºå¯¸: {resized_torch_false.shape}")
    
    # æ£€æŸ¥è¾¹ç•Œåƒç´ æ˜¯å¦å¯¹é½
    print("\nè¾¹ç•Œåƒç´ å¯¹æ¯”ï¼ˆå–ç¬¬ä¸€ä¸ªé€šé“ï¼‰:")
    print(f"è¾“å…¥è¾¹ç•Œ: [{test_img[0, 0, 0]:.3f}, {test_img[0, -1, 0]:.3f}, "
          f"{test_img[-1, 0, 0]:.3f}, {test_img[-1, -1, 0]:.3f}]")
    print(f"Torch True  è¾¹ç•Œ: [{resized_torch_true[0, 0, 0]:.3f}, "
          f"{resized_torch_true[0, -1, 0]:.3f}, {resized_torch_true[-1, 0, 0]:.3f}, "
          f"{resized_torch_true[-1, -1, 0]:.3f}]")
    print(f"Torch False è¾¹ç•Œ: [{resized_torch_false[0, 0, 0]:.3f}, "
          f"{resized_torch_false[0, -1, 0]:.3f}, {resized_torch_false[-1, 0, 0]:.3f}, "
          f"{resized_torch_false[-1, -1, 0]:.3f}]")
    
    if TF_AVAILABLE:
        # TensorFlow: align_corners=True
        img_tf = tf.constant(test_img, dtype=tf.float32)  # (4, 4, 3)
        resized_tf_true = tf_resize(
            img_tf, target_size, method='bilinear', align_corners=True
        ).numpy()
        
        # TensorFlow: align_corners=Falseï¼ˆé»˜è®¤è¡Œä¸ºï¼‰
        resized_tf_false = tf_resize(
            img_tf, target_size, method='bilinear', align_corners=False
        ).numpy()
        
        print(f"\nTF True  è¾¹ç•Œ: [{resized_tf_true[0, 0, 0]:.3f}, "
              f"{resized_tf_true[0, -1, 0]:.3f}, {resized_tf_true[-1, 0, 0]:.3f}, "
              f"{resized_tf_true[-1, -1, 0]:.3f}]")
        print(f"TF False è¾¹ç•Œ: [{resized_tf_false[0, 0, 0]:.3f}, "
              f"{resized_tf_false[0, -1, 0]:.3f}, {resized_tf_false[-1, 0, 0]:.3f}, "
              f"{resized_tf_false[-1, -1, 0]:.3f}]")
        
        # è®¡ç®—å·®å¼‚
        diff_tf_torch_false = np.abs(resized_tf_false - resized_torch_false)
        print(f"\nTF vs PyTorch (align_corners=False) æœ€å¤§å·®å¼‚: {diff_tf_torch_false.max():.6f}")
        print(f"TF vs PyTorch (align_corners=False) å¹³å‡å·®å¼‚: {diff_tf_torch_false.mean():.6f}")
    
    return {
        'input': test_img,
        'torch_true': resized_torch_true,
        'torch_false': resized_torch_false,
        'tf_true': resized_tf_true if TF_AVAILABLE else None,
        'tf_false': resized_tf_false if TF_AVAILABLE else None,
    }


def test_coordinate_mapping():
    """æµ‹è¯•åæ ‡æ˜ å°„çš„æ•°å­¦å·®å¼‚"""
    print("\n" + "="*80)
    print("æµ‹è¯• 2: åæ ‡æ˜ å°„çš„æ•°å­¦å·®å¼‚")
    print("="*80)
    
    # åˆ›å»ºä¸€ä¸ªç®€å•çš„æµ‹è¯•å›¾åƒï¼ˆ4x4 -> 8x8ï¼‰
    H_in, W_in = 4, 4
    H_out, W_out = 8, 8
    
    # åˆ›å»ºä¸€ä¸ªæœ‰ç‰¹å¾çš„å›¾åƒï¼ˆä¸­å¿ƒæœ‰ä¸€ä¸ªäº®ç‚¹ï¼‰
    test_img = np.zeros((H_in, W_in, 3), dtype=np.float32)
    test_img[2, 2, :] = 1.0  # ä¸­å¿ƒåƒç´ ä¸º 1
    
    print(f"è¾“å…¥å›¾åƒå°ºå¯¸: {test_img.shape}")
    print(f"è¾“å‡ºå›¾åƒå°ºå¯¸: ({H_out}, {W_out})")
    
    # PyTorch: align_corners=False
    img_torch = torch.FloatTensor(test_img).permute(2, 0, 1).unsqueeze(0)
    resized_torch = F.interpolate(
        img_torch, size=(H_out, W_out), mode='bilinear', align_corners=False
    ).squeeze(0).permute(1, 2, 0).numpy()
    
    # æ‰¾åˆ°è¾“å‡ºå›¾åƒä¸­æœ€å¤§å€¼çš„ä½ç½®
    max_pos_torch = np.unravel_index(np.argmax(resized_torch[:, :, 0]), resized_torch.shape[:2])
    print(f"\nPyTorch (align_corners=False) æœ€å¤§å€¼ä½ç½®: {max_pos_torch}")
    print(f"  ç†è®ºä¸­å¿ƒä½ç½®åº”è¯¥æ˜¯ (4, 4)ï¼Œå®é™…: {max_pos_torch}")
    
    if TF_AVAILABLE:
        # TensorFlow: align_corners=Falseï¼ˆé»˜è®¤è¡Œä¸ºï¼‰
        img_tf = tf.constant(test_img, dtype=tf.float32)
        resized_tf = tf_resize(
            img_tf, (H_out, W_out), method='bilinear', align_corners=False
        ).numpy()
        
        max_pos_tf = np.unravel_index(np.argmax(resized_tf[:, :, 0]), resized_tf.shape[:2])
        print(f"\nTensorFlow (align_corners=False) æœ€å¤§å€¼ä½ç½®: {max_pos_tf}")
        print(f"  ç†è®ºä¸­å¿ƒä½ç½®åº”è¯¥æ˜¯ (4, 4)ï¼Œå®é™…: {max_pos_tf}")
        
        # è®¡ç®—ä½ç½®å·®å¼‚
        pos_diff = np.array(max_pos_torch) - np.array(max_pos_tf)
        print(f"\nä½ç½®å·®å¼‚: {pos_diff}")
        print(f"  è¿™åæ˜ äº†åæ ‡æ˜ å°„çš„å·®å¼‚ï¼ˆhalf-pixel center vs scale-factorï¼‰")
    
    return {
        'input': test_img,
        'torch': resized_torch,
        'tf': resized_tf if TF_AVAILABLE else None,
    }


def test_real_image_resize():
    """ä½¿ç”¨çœŸå®å›¾åƒæµ‹è¯• resize å·®å¼‚"""
    print("\n" + "="*80)
    print("æµ‹è¯• 3: ä½¿ç”¨çœŸå®å›¾åƒæµ‹è¯• resize å·®å¼‚")
    print("="*80)
    
    # åŠ è½½çœŸå®å›¾åƒ
    img_array, img_path = load_test_image()
    H_orig, W_orig = img_array.shape[:2]
    
    # å½’ä¸€åŒ–åˆ° [0, 1]
    img_norm = img_array / 255.0
    
    # ç›®æ ‡å°ºå¯¸ï¼ˆåŒ¹é… IBC çš„é…ç½®ï¼‰
    target_height, target_width = 180, 240
    
    print(f"åŸå§‹å°ºå¯¸: ({H_orig}, {W_orig})")
    print(f"ç›®æ ‡å°ºå¯¸: ({target_height}, {target_width})")
    
    # PyTorch: align_corners=Falseï¼ˆé»˜è®¤ï¼‰
    img_torch = torch.FloatTensor(img_norm).permute(2, 0, 1).unsqueeze(0)  # (1, 3, H, W)
    resized_torch = F.interpolate(
        img_torch, size=(target_height, target_width), mode='bilinear', align_corners=False
    ).squeeze(0).permute(1, 2, 0).numpy()
    
    print(f"PyTorch è¾“å‡ºå°ºå¯¸: {resized_torch.shape}")
    print(f"PyTorch è¾“å‡ºå€¼èŒƒå›´: [{resized_torch.min():.3f}, {resized_torch.max():.3f}]")
    
    if TF_AVAILABLE:
        # TensorFlow: ä½¿ç”¨ä¸ IBC å®˜æ–¹å®Œå…¨ç›¸åŒçš„è°ƒç”¨æ–¹å¼
        # IBC å®˜æ–¹ä»£ç : tf.image.resize(images, [target_height, target_width])
        # ä¸æŒ‡å®š method å‚æ•°ï¼Œä½¿ç”¨é»˜è®¤çš„ 'bilinear'
        img_tf = tf.constant(img_norm, dtype=tf.float32)  # (H, W, 3)
        
        # æ–¹å¼1: å®Œå…¨åŒ¹é… IBC å®˜æ–¹çš„è°ƒç”¨ï¼ˆä¸æŒ‡å®š methodï¼‰
        resized_tf_ibc = tf.image.resize(img_tf, [target_height, target_width]).numpy()
        
        # æ–¹å¼2: ä½¿ç”¨æˆ‘ä»¬çš„ tf_resize å‡½æ•°ï¼ˆæ˜¾å¼æŒ‡å®š method='bilinear'ï¼‰
        resized_tf_explicit = tf_resize(
            img_tf, (target_height, target_width), method='bilinear', align_corners=False
        ).numpy()
        
        # éªŒè¯ä¸¤ç§æ–¹å¼æ˜¯å¦ä¸€è‡´
        diff_methods = np.abs(resized_tf_ibc - resized_tf_explicit)
        print(f"\nTensorFlow ä¸¤ç§è°ƒç”¨æ–¹å¼å¯¹æ¯”:")
        print(f"  IBC å®˜æ–¹æ–¹å¼ï¼ˆä¸æŒ‡å®š methodï¼‰è¾“å‡ºå°ºå¯¸: {resized_tf_ibc.shape}")
        print(f"  æ˜¾å¼æŒ‡å®š method='bilinear' è¾“å‡ºå°ºå¯¸: {resized_tf_explicit.shape}")
        print(f"  ä¸¤ç§æ–¹å¼çš„æœ€å¤§å·®å¼‚: {diff_methods.max():.6f}")
        print(f"  ä¸¤ç§æ–¹å¼æ˜¯å¦å®Œå…¨ä¸€è‡´: {np.allclose(resized_tf_ibc, resized_tf_explicit, atol=1e-6)}")
        
        # ä½¿ç”¨ IBC å®˜æ–¹æ–¹å¼çš„ç»“æœè¿›è¡Œåç»­å¯¹æ¯”
        resized_tf = resized_tf_ibc
        
        print(f"\nTensorFlow (IBC å®˜æ–¹æ–¹å¼) è¾“å‡ºå°ºå¯¸: {resized_tf.shape}")
        print(f"TensorFlow è¾“å‡ºå€¼èŒƒå›´: [{resized_tf.min():.3f}, {resized_tf.max():.3f}]")
        
        # è®¡ç®—å·®å¼‚
        diff = np.abs(resized_tf - resized_torch)
        print(f"\nTF (IBC å®˜æ–¹æ–¹å¼) vs PyTorch å·®å¼‚ç»Ÿè®¡:")
        print(f"  æœ€å¤§å·®å¼‚: {diff.max():.6f}")
        print(f"  å¹³å‡å·®å¼‚: {diff.mean():.6f}")
        print(f"  æ ‡å‡†å·®: {diff.std():.6f}")
        print(f"  å·®å¼‚ > 0.01 çš„åƒç´ æ¯”ä¾‹: {(diff > 0.01).sum() / diff.size * 100:.2f}%")
        print(f"  å·®å¼‚ > 0.05 çš„åƒç´ æ¯”ä¾‹: {(diff > 0.05).sum() / diff.size * 100:.2f}%")
        
        # è®¡ç®—ç›¸å¯¹è¯¯å·®
        relative_error = diff / (np.abs(resized_tf) + 1e-8)
        print(f"\nç›¸å¯¹è¯¯å·®ç»Ÿè®¡:")
        print(f"  æœ€å¤§ç›¸å¯¹è¯¯å·®: {relative_error.max():.6f}")
        print(f"  å¹³å‡ç›¸å¯¹è¯¯å·®: {relative_error.mean():.6f}")
    
    return {
        'original': img_norm,
        'torch': resized_torch,
        'tf': resized_tf if TF_AVAILABLE else None,
        'diff': diff if TF_AVAILABLE else None,
    }


def test_boundary_behavior():
    """æµ‹è¯•è¾¹ç•Œå¤–è¡Œä¸ºï¼ˆextrapolationï¼‰"""
    print("\n" + "="*80)
    print("æµ‹è¯• 4: è¾¹ç•Œå¤–è¡Œä¸ºï¼ˆextrapolationï¼‰")
    print("="*80)
    
    # åˆ›å»ºä¸€ä¸ªæµ‹è¯•å›¾åƒï¼Œè¾¹ç¼˜æœ‰æ˜æ˜¾çš„å€¼
    test_img = np.zeros((10, 10, 3), dtype=np.float32)
    test_img[0, :, :] = 1.0  # ä¸Šè¾¹ç¼˜
    test_img[-1, :, :] = 1.0  # ä¸‹è¾¹ç¼˜
    test_img[:, 0, :] = 1.0  # å·¦è¾¹ç¼˜
    test_img[:, -1, :] = 1.0  # å³è¾¹ç¼˜
    
    print(f"è¾“å…¥å›¾åƒå°ºå¯¸: {test_img.shape}")
    print(f"è¾¹ç¼˜åƒç´ å€¼: 1.0ï¼Œä¸­å¿ƒåƒç´ å€¼: 0.0")
    
    # æ”¾å¤§åˆ° 20x20
    target_size = (20, 20)
    
    # PyTorch
    img_torch = torch.FloatTensor(test_img).permute(2, 0, 1).unsqueeze(0)
    resized_torch = F.interpolate(
        img_torch, size=target_size, mode='bilinear', align_corners=False
    ).squeeze(0).permute(1, 2, 0).numpy()
    
    print(f"\nPyTorch è¾“å‡ºå°ºå¯¸: {resized_torch.shape}")
    print(f"PyTorch è¾¹ç¼˜åƒç´ å€¼ï¼ˆå–ç¬¬ä¸€ä¸ªé€šé“ï¼‰:")
    print(f"  ä¸Šè¾¹ç¼˜: {resized_torch[0, :5, 0]}")
    print(f"  ä¸‹è¾¹ç¼˜: {resized_torch[-1, :5, 0]}")
    print(f"  å·¦è¾¹ç¼˜: {resized_torch[:5, 0, 0]}")
    print(f"  å³è¾¹ç¼˜: {resized_torch[:5, -1, 0]}")
    
    if TF_AVAILABLE:
        # TensorFlowï¼ˆé»˜è®¤è¡Œä¸ºï¼Œç›¸å½“äº align_corners=Falseï¼‰
        img_tf = tf.constant(test_img, dtype=tf.float32)
        resized_tf = tf_resize(
            img_tf, target_size, method='bilinear', align_corners=False
        ).numpy()
        
        print(f"\nTensorFlow è¾“å‡ºå°ºå¯¸: {resized_tf.shape}")
        print(f"TensorFlow è¾¹ç¼˜åƒç´ å€¼ï¼ˆå–ç¬¬ä¸€ä¸ªé€šé“ï¼‰:")
        print(f"  ä¸Šè¾¹ç¼˜: {resized_tf[0, :5, 0]}")
        print(f"  ä¸‹è¾¹ç¼˜: {resized_tf[-1, :5, 0]}")
        print(f"  å·¦è¾¹ç¼˜: {resized_tf[:5, 0, 0]}")
        print(f"  å³è¾¹ç¼˜: {resized_tf[:5, -1, 0]}")
        
        # è®¡ç®—è¾¹ç¼˜å·®å¼‚
        edge_diff = np.abs(resized_tf - resized_torch)
        print(f"\nè¾¹ç¼˜å·®å¼‚ç»Ÿè®¡:")
        print(f"  æœ€å¤§å·®å¼‚: {edge_diff.max():.6f}")
        print(f"  è¾¹ç¼˜åŒºåŸŸå¹³å‡å·®å¼‚: {edge_diff[[0, -1], :, :].mean():.6f}")
    
    return {
        'input': test_img,
        'torch': resized_torch,
        'tf': resized_tf if TF_AVAILABLE else None,
    }


def test_scale_factor_vs_size():
    """æµ‹è¯• scale_factor vs size çš„è¡Œä¸ºå·®å¼‚"""
    print("\n" + "="*80)
    print("æµ‹è¯• 5: scale_factor vs size çš„è¡Œä¸ºå·®å¼‚")
    print("="*80)
    
    # åˆ›å»ºæµ‹è¯•å›¾åƒ
    test_img = np.random.rand(100, 100, 3).astype(np.float32)
    
    # ä½¿ç”¨ size
    target_size = (200, 200)
    img_torch = torch.FloatTensor(test_img).permute(2, 0, 1).unsqueeze(0)
    resized_size = F.interpolate(
        img_torch, size=target_size, mode='bilinear', align_corners=False
    ).squeeze(0).permute(1, 2, 0).numpy()
    
    # ä½¿ç”¨ scale_factor
    scale_factor = 2.0
    resized_scale = F.interpolate(
        img_torch, scale_factor=scale_factor, mode='bilinear', align_corners=False
    ).squeeze(0).permute(1, 2, 0).numpy()
    
    print(f"è¾“å…¥å°ºå¯¸: {test_img.shape}")
    print(f"ä½¿ç”¨ size={target_size} è¾“å‡º: {resized_size.shape}")
    print(f"ä½¿ç”¨ scale_factor={scale_factor} è¾“å‡º: {resized_scale.shape}")
    
    # æ£€æŸ¥æ˜¯å¦ä¸€è‡´
    diff = np.abs(resized_size - resized_scale)
    print(f"\nä¸¤ç§æ–¹å¼å·®å¼‚:")
    print(f"  æœ€å¤§å·®å¼‚: {diff.max():.6f}")
    print(f"  å¹³å‡å·®å¼‚: {diff.mean():.6f}")
    print(f"  æ˜¯å¦å®Œå…¨ä¸€è‡´: {np.allclose(resized_size, resized_scale, atol=1e-6)}")
    
    return {
        'input': test_img,
        'size': resized_size,
        'scale': resized_scale,
        'diff': diff,
    }


def visualize_comparison(results_real):
    """å¯è§†åŒ–çœŸå®å›¾åƒçš„ resize ç»“æœå¯¹æ¯”"""
    if not TF_AVAILABLE or results_real['tf'] is None:
        print("\nâš  è·³è¿‡å¯è§†åŒ–ï¼ˆTensorFlow ä¸å¯ç”¨ï¼‰")
        return
    
    print("\n" + "="*80)
    print("å¯è§†åŒ–å¯¹æ¯”")
    print("="*80)
    
    fig, axes = plt.subplots(2, 3, figsize=(15, 10))
    
    # åŸå§‹å›¾åƒï¼ˆç¼©å°æ˜¾ç¤ºï¼‰
    orig = results_real['original']
    if orig.shape[0] > 300 or orig.shape[1] > 400:
        # å¦‚æœå¤ªå¤§ï¼Œå…ˆç¼©å°æ˜¾ç¤º
        from PIL import Image
        orig_display = np.array(Image.fromarray((orig * 255).astype(np.uint8)).resize(
            (400, 300), Image.BILINEAR)) / 255.0
    else:
        orig_display = orig
    
    axes[0, 0].imshow(orig_display)
    axes[0, 0].set_title(f'Original Image\n{orig.shape[:2]}')
    axes[0, 0].axis('off')
    
    # PyTorch ç»“æœ
    axes[0, 1].imshow(results_real['torch'])
    axes[0, 1].set_title(f'PyTorch F.interpolate\nalign_corners=False')
    axes[0, 1].axis('off')
    
    # TensorFlow ç»“æœ
    axes[0, 2].imshow(results_real['tf'])
    axes[0, 2].set_title(f'TensorFlow tf.image.resize\nalign_corners=False')
    axes[0, 2].axis('off')
    
    # å·®å¼‚å›¾
    diff = results_real['diff']
    im = axes[1, 0].imshow(diff.max(axis=2), cmap='hot', vmin=0, vmax=diff.max())
    axes[1, 0].set_title('Absolute Difference')
    axes[1, 0].axis('off')
    plt.colorbar(im, ax=axes[1, 0])
    
    # å·®å¼‚ç›´æ–¹å›¾
    axes[1, 1].hist(diff.flatten(), bins=50, edgecolor='black')
    axes[1, 1].set_title('Difference Distribution')
    axes[1, 1].set_xlabel('Difference Value')
    axes[1, 1].set_ylabel('Frequency')
    
    # ç›¸å¯¹è¯¯å·®å›¾
    relative_error = diff / (np.abs(results_real['tf']) + 1e-8)
    im = axes[1, 2].imshow(relative_error.max(axis=2), cmap='hot', vmin=0, vmax=0.1)
    axes[1, 2].set_title('Relative Error')
    axes[1, 2].axis('off')
    plt.colorbar(im, ax=axes[1, 2])
    
    plt.tight_layout()
    
    # ä¿å­˜å›¾åƒ
    output_path = IBC_ROOT / "tutorials" / "interpolate_comparison.png"
    plt.savefig(output_path, dpi=150, bbox_inches='tight')
    print(f"âœ“ å¯è§†åŒ–ç»“æœå·²ä¿å­˜åˆ°: {output_path}")
    
    plt.close()


def main():
    """ä¸»å‡½æ•°ï¼šè¿è¡Œæ‰€æœ‰æµ‹è¯•"""
    print("="*80)
    print("TensorFlow vs PyTorch Resize å·®å¼‚éªŒè¯")
    print("="*80)
    print(f"æ•°æ®ç›®å½•: {DATA_DIR}")
    print(f"TensorFlow å¯ç”¨: {TF_AVAILABLE}")
    print(f"PyTorch ç‰ˆæœ¬: {torch.__version__}")
    if TF_AVAILABLE:
        print(f"TensorFlow ç‰ˆæœ¬: {TF_VERSION}")
        print(f"æ³¨æ„: TensorFlow 2.x çš„ tf.image.resize é»˜è®¤ç›¸å½“äº align_corners=False")
        print(f"      ä½¿ç”¨ tf.compat.v1.image.resize_images æ¥æµ‹è¯• align_corners=True")
        print(f"\nIBC å®˜æ–¹è°ƒç”¨æ–¹å¼:")
        print(f"  tf.image.resize(images, [target_height, target_width])")
        print(f"  ä¸æŒ‡å®š method å‚æ•°ï¼Œä½¿ç”¨é»˜è®¤çš„ 'bilinear'")
        print(f"  é»˜è®¤è¡Œä¸ºç›¸å½“äº align_corners=False (half-pixel center)")
    
    # è¿è¡Œæ‰€æœ‰æµ‹è¯•
    results = {}
    
    try:
        results['align_corners'] = test_align_corners_effect()
    except Exception as e:
        print(f"âŒ æµ‹è¯• 1 å¤±è´¥: {e}")
        import traceback
        traceback.print_exc()
    
    try:
        results['coordinate_mapping'] = test_coordinate_mapping()
    except Exception as e:
        print(f"âŒ æµ‹è¯• 2 å¤±è´¥: {e}")
        import traceback
        traceback.print_exc()
    
    try:
        results['real_image'] = test_real_image_resize()
        if TF_AVAILABLE:
            visualize_comparison(results['real_image'])
    except Exception as e:
        print(f"âŒ æµ‹è¯• 3 å¤±è´¥: {e}")
        import traceback
        traceback.print_exc()
    
    try:
        results['boundary'] = test_boundary_behavior()
    except Exception as e:
        print(f"âŒ æµ‹è¯• 4 å¤±è´¥: {e}")
        import traceback
        traceback.print_exc()
    
    try:
        results['scale_factor'] = test_scale_factor_vs_size()
    except Exception as e:
        print(f"âŒ æµ‹è¯• 5 å¤±è´¥: {e}")
        import traceback
        traceback.print_exc()
    
    print("\n" + "="*80)
    print("æ‰€æœ‰æµ‹è¯•å®Œæˆï¼")
    print("="*80)
    
    # # æ€»ç»“
    # print("\nğŸ“Š æ€»ç»“:")
    # print("1. align_corners å‚æ•°å½±å“è¾¹ç•Œåƒç´ çš„å¯¹é½æ–¹å¼")
    # print("2. TensorFlow å’Œ PyTorch åœ¨ align_corners=False æ—¶ä»æœ‰åæ ‡æ˜ å°„å·®å¼‚")
    # print("3. TensorFlow ä½¿ç”¨ half-pixel centerï¼ŒPyTorch ä½¿ç”¨ scale-factor based")
    # print("4. è¿™ç§å·®å¼‚åœ¨è§†è§‰ä»»åŠ¡ä¸­å¯èƒ½å¯¼è‡´åƒç´ çº§åç§»")
    # print("5. å¯¹äº CNN ç‰¹å¾å›¾ï¼ŒPyTorch çš„æ’å€¼æ›´ç¬¦åˆå·ç§¯è¯­ä¹‰")
    # print("6. å¯¹äºçœŸå®å›¾åƒå¤„ç†ï¼ŒTensorFlow æ›´æ¥è¿‘ OpenCV æ ‡å‡†")


if __name__ == "__main__":
    main()

